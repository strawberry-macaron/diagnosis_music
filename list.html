<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>イメソン一覧</title>

<style>
body {
  background: #1b1630;
  color: #fff;
  font-family: sans-serif;
  padding: 20px;
}

.container {
  max-width: 700px;
  margin: auto;
}

h2 {
  text-align: center;
}

.search {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

input, select {
  padding: 8px;
  border-radius: 8px;
  border: none;
  flex: 1;
}

.song {
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
}

.tags span {
  font-size: 12px;
  background: #9b8cff;
  padding: 3px 8px;
  border-radius: 999px;
  margin-right: 5px;
}

.tag {
  cursor: pointer;
}

a {
  color: #9b8cff;
  text-decoration: none;
}
</style>
</head>

<body>
<div class="container">
  <h2>イメソン一覧</h2>

  <div class="search">
    <input id="searchCP" placeholder="CP名で検索（例：A×B）">
    <select id="searchTag">
      <option value="">タグを選択</option>
      <option value="sweet">甘い</option>
      <option value="heavy">重い</option>
      <option value="sad">切ない</option>
      <option value="crazy">狂気</option>
      <option value="happy">ハッピーエンド</option>
      <option value="merrybad">メリーバッド</option>
      <option value="badend">バッドエンド</option>
    </select>
  </div>

  <div id="list">読み込み中...</div>

  <p style="text-align:center">
    <a href="index.html">← ホームに戻る</a>
  </p>
</div>

<script>
const SPREADSHEET_ID = "1QfGEp_HR_SMv2SKofPrPbyl0BfGslCUdAKIr3DFqZo0";
const URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`;


const listEl = document.getElementById("list");
const cpInput = document.getElementById("searchCP");
const tagSelect = document.getElementById("searchTag");

let allSongs = [];

// Google Sheets から読み込み
async function loadSongs() {
  const res = await fetch(URL);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));
  const rows = json.table.rows;

  return rows.map(r => ({
    title: r.c[0]?.v || "",
    artist: r.c[1]?.v || "",
    youtube: r.c[2]?.v || "",
    cp: r.c[3]?.v || "",
    tags: r.c[4]?.v ? r.c[4].v.split(",") : [],
    reason: r.c[5]?.v || ""
  }));
}

function render() {
  const cp = cpInput.value.trim();
  const tag = tagSelect.value;

  listEl.innerHTML = "";

  const filtered = allSongs.filter(s => {
    if (cp && !s.cp.includes(cp)) return false;
    if (tag && !s.tags.includes(tag)) return false;
    return true;
  });

  if (filtered.length === 0) {
    listEl.innerHTML = "<p>該当する曲がありません</p>";
    return;
  }

  filtered.forEach(s => {
    listEl.innerHTML += `
      <div class="song">
        <strong>${s.title}</strong> / ${s.artist}<br>
        CP：${s.cp}<br>
        <a href="${s.youtube}" target="_blank">YouTubeで聴く</a>
        <p>${s.reason}</p>
        <div class="tags">
          ${s.tags.map(t => `<span class="tag">${t}</span>`).join("")}
        </div>
      </div>
    `;
  });
}

// 初期化
(async () => {
  allSongs = await loadSongs();
  render();
})();

cpInput.addEventListener("input", render);
tagSelect.addEventListener("change", render);
</script>

</body>
</html>